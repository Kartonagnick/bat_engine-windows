
![arch](arch/struct.png)

Архитектура движка  
------------------

Представлена в виде свободных компонентов:  

| компонент | предназначение                                             |
|:---------:|:----------------------------------------------------------:| 
| 7z        | обнаружить 7z.exe                                          |
| cmake     | обнаружить cmake.exe                                       |
| git       | обнаружить git.exe                                         |
| mingw     | обнаружить компиляторы mingw                               |
| msvc      | обнаружить компиляторы cl, и уметь запустить Visual Studio |
| qtcreator | обнаружить, и уметь запустить qtcreator                    |
| tools     | мелкие бат-утилитки                                        |

И в виде связанных компонентов собственно движка:

<pre>
       +----------+   +--------+
   .---| <a href="arch/001-initial.md" title="обновление запчастей движка">initial</a>  |---| <a href="arch/002-update.md" title="обновление настроек движка">update</a> |
  |    +----------+   +--------+
  |                     ↑  
+-----------+           ;
| <a href="arch/000-run.md" title="запуск движка">run</a>       |      .---'
+-----------+     '
  |              |
  |   +--------------+  +--------------+  +----------------+
  |`--| <a href="arch/003-settings.md" title="настройки движка">settings</a>     |--| <a href="arch/004-parseCommand.md" title="парсинг команды">parseCommand</a> |--| <a href="arch/005-parseArguments.md" title="парсинг атрибутов команды">parseArguments</a> |
  |   +--------------+  +--------------+  +----------------+
  |
  |   +-------------------------+  +------------------+  +--------+
  |`--| <a href="arch/006-detect.md" title="поиск каталога исходников">detect source directory</a> |--| <a href="arch/007-adjust.md" title="обработка аргументов командной строки">adjust arguments</a> |--| <a href="arch/008-expand.md" title="раскрытие строк форматирования в итоговые пути">expand</a> |
  |   +-------------------------+  +------------------+  +--------+
  |
  .   +---------------+              +------------+
   `--| <a href="arch/009-call.md" title="запуск команды">call commands</a> |           .--| <a href="arch/018-filtration.md" title="удаление неподдерживаемых конфигураций">filtration</a> |
      +---------------+          |   +------------+
        |                        |
        |   +----------+         |    +---------+          +---------------------+
        |`--| <a href="arch/010-generate.md" title="команда: 'generate'">generate</a> |--.      | .--| <a href="arch/017-request.md" title="обработка запроса конфигурации">request</a> |       .--| <a href="arch/cmake/000-generate.md" title="запускает cmake для генерации MakeFiles">generate-{COMPILER}</a> |
        |   +----------+   |     ||   +---------+      |   +---------------------+
        |                  |     ||                    |
        |   +----------+   |   +---------+  +------+   |   +---------------------+
        |`--| <a href="arch/011-build.md" title="команда: 'build'">build</a>    |---+--→| <a href="arch/016-configs.md" title="подготовка списка итоговых конфигураций">configs</a> |--| <a href="arch/019-loop.md" title="для каждой конфигурации запускает некоторый скрипт">loop</a> |---+---| <a href="arch/cmake/001-build.md" title="запускает cmake для сборки MakeFiles">build-{COMPILER}</a>    |
        |   +----------+   |   +---------+  +------+   |   +---------------------+
        |                  |                  |        |
        |   +----------+   |                  |        |   +---------------------+
        |`--| <a href="arch/012-install.md" title="команда: 'install'">install</a>  |--'|                  |         `--| <a href="arch/cmake/002-install.md" title="исталяция результатов сборки">install-{COMPILER}</a>  |
        |   +----------+   |                  |            +---------------------+
        |                  |                  ↓         
        |   +----------+   |                  |
        |`--| <a href="arch/013-clean.md" title="команда: 'clean'">clean</a>    |--'| ←---------------'|
        |   +----------+   |                  |
        |                  |                  |         
        |   +----------+   |                  ;
        |`--| <a href="arch/014-runTests.md" title="команда: 'runTests'">runTests</a> |--'  ←---------------'
        |   +----------+        
        |                      +-----------+
        |                   .--| <a href="arch/runIDE/run-msvc.md" title="запускает Visual Studio">run-msvc</a>  |
        .   +----------+   |   +-----------+
         `--| <a href="arch/015-runIDE.md" title="команда: 'runIDE'">runIDE</a>   |---|
            +----------+   |   +-----------+
	                    `--| <a href="arch/runIDE/run-mingw.md" title="запускает QtCreator">run-mingw</a> |
	                       +-----------+
</pre>

1.    Все начинается с компонента run.  
1.1     Движок парсит имя команды.
2.    Далее, движок проверяет:  
2.1     Был ли он запущен без аргументов.  
2.2     Была ли команда update.  
2.3     Была ли команда initial.  
2.4     Была ли команда version.  
3.    Далее движок проверяет:  
3.1     Существует ли батник с таким же названием как и команда.  
3.1.1     Если нет - ошибка и завершение работы.  
4.    Далее движок подгружает настройки, запуская `settings`  
5.    Далее движок парсит атрибуты команды, запуская `parseArguments`  
6.    Далее движок определяет каталог исходного кода, запуская `detect source directory`  
7.    Далее движок корректирует атрибуты, запуская `adjust arguments`  
8.    Далее движок применяет к атрибутам `expand`  
9.    Теперь команда и атрибуты готовы.  
10.   Движок исполняет команду:  
10.1    Для этого он запускает батник с таким же названием, как и команда.  
11.   Команда runIDE в качестве аргумента требует указать одну полную конфигурацию.  
11.1    Зная конфигурацию, она запускает соответствующий батник:  
11.1.1    run-msvc для Visual Studio.  
11.1.2    run-mingw для QtCreator.  
12.   Остальные команды: generate, build, install, runTests и clean:  
12.1.   Запускают `configs`, что бы получить список конфигураций.  
13.   Далее команды запускают `loop`, что бы совершить действие для каждой конфигурации:  
13.1.  `generate` -> `cmake/generate-{COMPILER}`  
13.2.  `build` -> `cmake/build-{COMPILER}`  
13.3.  `install` -> `cmake/install-{COMPILER}`  
14.   Команды `clean` и `runTest` рекурсивно запускают сами себя:  
14.1   Для того, что бы выполнить действие для конкретной конфигурации.  
15.   Модуль `configs` работает согласно алгоритму:  
15.1   Сначала он парсит фаайл `project.root`  
15.2.  В результате получается 3 строки запроса:  
15.2.1   Желаемые конфигурации.  
15.2.2   Поддерживаемые конфигурации.  
15.2.3   Не поддерживаемые конфигурации.  
15.3   Затем с помощью `request` преобразует каждый запрос в список итоговых конфигураций  
15.4   Затем с помощью `filtration` определяет убирает лишнее  
15.5   Получается итоговый список конфигураций, который должна обработать команда.  








